{
  "sources": [
    {
      "slug": "isa-knowledge-base",
      "required": true,
      "tools": [
        "isa_hybrid_search",
        "isa_hop_retrieve",
        "isa_list_standards",
        "isa_get_paragraph",
        "isa_entity_verify",
        "isa_citation_verify",
        "isa_relation_verify",
        "isa_contradiction_check",
        "isa_format_context",
        "isa_web_search",
        "isa_guide_search",
        "isa_guide_to_isa_hop",
        "isa_list_guides",
        "isa_multi_tier_search",
        "isa_kb_status",
        "isa_debug_hop_trace"
      ]
    }
  ],
  "controlFlow": {
    "stages": [
      {
        "id": 0,
        "name": "analyze_query",
        "description": "Decompose query and optionally calibrate with web search",
        "pauseInstructions": "Respond in ONE of two modes based on clarity_score:\n\nFORMAT RULES:\n- First line: READY (clarity >= 0.7) or CLARIFYING (clarity < 0.7)\n- Blank line, then 1-3 sentence narrative\n- Include 'Planned research queries:' section with bullets: • [role] query — standards\n- End with 1 focused question (2-3 numbered options)\n- No tables, no depth/scope labels\n\nMODE A (READY): State your understanding + key assumptions. Ask ONE clarification question with numbered options.\n\nMODE B (CLARIFYING): State what's ambiguous. Ask focused questions with numbered options.\n\nWEBSEARCH (unless quick mode): End with:\nWould you like me to run a web search to refine my understanding before starting research?\nA. Yes — search authoritative ISA sources to sharpen the query plan\nB. No — proceed directly with the current query plan\n\nIMPORTANT: Present this ONCE. After the user responds, the resume protocol handles the next step — do NOT re-present this output."
      },
      {
        "id": 1,
        "name": "websearch_calibration",
        "description": "Optional web search to refine intent and query plan",
        "pauseInstructions": "Present what the web search revealed and how it changed the query plan.\n\nFORMAT:\n- First line: CALIBRATED (if changes found) or CONFIRMED (if no changes)\n- 1-3 sentences summarizing what web sources revealed\n- 'Changes made:' section listing additions/modifications/removals\n- 'Full updated research plan:' listing ALL sub-queries with roles (mark NEW and MODIFIED)\n- End with: 'Shall I proceed?\\n1. Yes — start retrieval with the refined query plan\\n2. Modify — I'd like to adjust something before proceeding'\n\nIMPORTANT: Present this ONCE. After the user responds, the resume protocol handles the next step — do NOT re-present this output."
      },
      { "id": 2, "name": "retrieve", "description": "Hybrid search + graph traversal + context formatting" },
      { "id": 3, "name": "synthesize", "description": "Generate structured answer from XML context" },
      { "id": 4, "name": "verify", "description": "4-axis verification (EG, CA, RP, CD)" },
      { "id": 5, "name": "output", "description": "Format final output with progressive disclosure" }
    ],
    "repairUnits": [
      {
        "stages": [3, 4],
        "maxIterations": 2,
        "feedbackField": "feedback"
      }
    ],
    "pauseAfterStages": [0, 1],
    "autoAdvance": true,
    "pauseOnErrors": ["auth", "config"],
    "stageOutputSchemas": {
      "0": {
        "required": ["query_plan"],
        "properties": {
          "query_plan": {
            "type": "object",
            "required": ["original_query", "clarity_score", "sub_queries", "depth_mode", "primary_standards", "recommended_action"],
            "properties": {
              "original_query": { "type": "string" },
              "clarity_score": { "type": "number", "minimum": 0, "maximum": 1 },
              "recommended_action": { "type": "string", "enum": ["proceed", "clarify"] },
              "assumptions": { "type": "array" },
              "alternative_interpretations": { "type": "array" },
              "clarification_questions": { "type": "array" },
              "primary_standards": { "type": "array", "minItems": 1 },
              "sub_queries": { "type": "array", "minItems": 1 },
              "scope": { "type": "string" },
              "depth_mode": { "type": "string", "enum": ["quick", "standard", "deep"] },
              "authority_sources": {
                "type": "object",
                "properties": {
                  "search_queries": { "type": "array", "minItems": 3 },
                  "domain_hints": { "type": "array", "minItems": 3 },
                  "source_types": { "type": "array" }
                }
              }
            }
          }
        }
      },
      "1": {
        "required": ["websearch_calibration"],
        "properties": {
          "websearch_calibration": {
            "type": "object",
            "required": ["skipped", "query_plan_refined"],
            "properties": {
              "skipped": { "type": "boolean" },
              "skip_reason": { "type": "string" },
              "web_queries_executed": { "type": "number" },
              "web_sources": { "type": "array" },
              "intent_changes": {
                "type": "object",
                "properties": {
                  "sub_queries_added": { "type": "array" },
                  "sub_queries_modified": { "type": "array" },
                  "sub_queries_removed": { "type": "array" },
                  "sub_queries_demoted": { "type": "array" },
                  "scope_changed": { "type": "boolean" },
                  "standards_added": { "type": "array" }
                }
              },
              "web_research_context": { "type": "string" },
              "query_plan_refined": { "type": "boolean" }
            }
          }
        }
      },
      "2": {
        "required": ["retrieval_summary"],
        "properties": {
          "retrieval_summary": {
            "type": "object",
            "required": ["total_paragraphs_found", "unique_after_dedup", "standards_covered", "role_counts"],
            "properties": {
              "total_paragraphs_found": { "type": "number" },
              "unique_after_dedup": { "type": "number" },
              "standards_covered": { "type": "array", "minItems": 1 },
              "role_counts": {
                "type": "object",
                "properties": {
                  "primary": { "type": "number" },
                  "supporting": { "type": "number" },
                  "context": { "type": "number" }
                }
              },
              "skipped_sub_queries": { "type": "array" }
            }
          }
        }
      },
      "3": {
        "required": ["synthesis", "citations_used"],
        "properties": {
          "synthesis": { "type": "string" },
          "citations_used": { "type": "array", "minItems": 1 }
        },
        "enforcement": "block",
        "blockMessage": "Stage 3 BLOCKED: synthesis (full text) and citations_used (array of citation refs) are required. Pass the complete synthesis text and the list of all citations used."
      },
      "4": {
        "required": ["verification_scores", "all_passed", "source_texts"],
        "properties": {
          "verification_scores": { "type": "object" },
          "all_passed": { "type": "boolean" },
          "source_texts": { "type": "object" },
          "missing_source_texts": { "type": "array" }
        },
        "enforcement": "block",
        "blockMessage": "Stage 4 BLOCKED: verification_scores, all_passed, and source_texts are required. source_texts must be a map of citation refs to verbatim paragraph text from isa_citation_verify results. Pass all verification data to complete Stage 4."
      },
      "5": {
        "required": ["answer_delivered", "output_file_path"],
        "properties": {
          "answer_delivered": { "type": "boolean" },
          "total_citations": { "type": "number" },
          "output_file_path": { "type": "string" },
          "source_texts_used": { "type": "number" },
          "renderer_tool_called": { "type": "boolean" }
        },
        "enforcement": "block",
        "blockMessage": "Stage 5 BLOCKED: answer_delivered and output_file_path are required. The output file must exist on disk. Preferred: call agent_render_research_output with sourceTexts. Alternative: write the file with the Write tool — the stage gate will inject > **Sources** blockquotes automatically from Stage 4 source_texts. Re-complete with answer_delivered: true and output_file_path set."
      }
    },
    "webSearch": {
      "enabled": true,
      "provider": "brave",
      "maxQueries": 5,
      "preferredDomains": [
        "ifac.org",
        "iaasb.org",
        "pcaobus.org",
        "aicpa.org",
        "accountancyeurope.eu"
      ]
    }
  },
  "depthModes": {
    "quick": {
      "maxSubQueries": 3,
      "maxParagraphsPerQuery": 10,
      "maxRepairIterations": 0,
      "contextTokenBudget": 4000,
      "maxSynthesisTokens": 2048,
      "enableWebSearch": false
    },
    "standard": {
      "maxSubQueries": 8,
      "maxParagraphsPerQuery": 20,
      "maxRepairIterations": 2,
      "contextTokenBudget": 12000,
      "maxSynthesisTokens": 4096,
      "enableWebSearch": true
    },
    "deep": {
      "maxSubQueries": 15,
      "maxParagraphsPerQuery": 30,
      "maxRepairIterations": 3,
      "contextTokenBudget": 24000,
      "maxSynthesisTokens": 8192,
      "enableWebSearch": true
    }
  },
  "verification": {
    "entityGrounding": { "threshold": 0.80 },
    "relationPreservation": { "threshold": 0.70 },
    "citationAccuracy": { "threshold": 0.75 },
    "contradictions": { "maxUnresolved": 0 }
  },
  "logging": {
    "level": "verbose",
    "persistIntermediates": true,
    "costTracking": true
  },
  "followUp": {
    "enabled": true,
    "deltaRetrieval": true,
    "maxAccumulatedSections": 30
  },
  "output": {
    "renderer": { "type": "research", "version": "1.0" },
    "titleTemplate": "ISA Research",
    "followupTitleTemplate": "ISA Research Follow-Up #{n}",
    "citationFormat": "ISA {number}.{paragraph}",
    "citationRegex": "(?:\\()?ISA \\d{3}(?:\\.\\d+)?(?:\\([a-z]\\))?(?:\\.A\\d+)?(?:\\))?",
    "sourceDiscovery": {
      "enabled": true,
      "linkerType": "isa-pdf",
      "linkBase": "../staging/pdf/"
    },
    "sections": {
      "externalReferencesTitle": "External Good Practice References",
      "priorResearchTitle": "Prior Research References",
      "verificationSummaryTitle": "Verification Summary",
      "citationsUsedTitle": "Citations Used",
      "researchDecompositionTitle": "Appendix: Research Decomposition"
    },
    "priorResearch": {
      "refFormat": "[P{num}]",
      "excerptLength": 200
    },
    "confidence": {
      "qualifierThresholds": { "high": 0.85, "medium": 0.70 }
    },
    "files": {
      "answerFile": "isa-research-output.md",
      "followupTemplate": "isa-research-output-followup-{n}.md"
    },
    "progressiveDisclosure": true
  },
  "debug": {
    "enabled": false,
    "maxParagraphs": 5,
    "maxToolCalls": 10,
    "skipVerification": false,
    "skipWebSearch": true,
    "useFixtures": false
  },
  "orchestrator": {
    "enabled": true,
    "model": "claude-opus-4-6",
    "thinking": { "type": "adaptive" },
    "effort": "max",
    "depthModeEffort": {
      "quick": "high",
      "standard": "high",
      "deep": "max"
    },
    "contextWindow": 200000,
    "minOutputBudget": 4096,
    "budgetUsd": 10.0,
    "perStageDesiredTokens": {
      "0": 16384,
      "1": 8192,
      "3": 128000,
      "5": 0
    },
    "useBAML": true,
    "bamlFallbackToZod": true
  }
}
