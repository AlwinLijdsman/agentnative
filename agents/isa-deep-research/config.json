{
  "controlFlow": {
    "stages": [
      {
        "id": 0,
        "name": "analyze_query",
        "description": "Decompose query and optionally calibrate with web search",
        "pauseInstructions": "Respond in ONE of two modes based on clarity_score:\n\nFORMAT RULES:\n- First line: READY (clarity >= 0.7) or CLARIFYING (clarity < 0.7)\n- Blank line, then 1-3 sentence narrative\n- Include 'Planned research queries:' section with bullets: • [role] query — standards\n- End with 1 focused question (2-3 numbered options)\n- No tables, no depth/scope labels\n\nMODE A (READY): State your understanding + key assumptions. Ask ONE clarification question with numbered options.\n\nMODE B (CLARIFYING): State what's ambiguous. Ask focused questions with numbered options.\n\nWEBSEARCH (unless quick mode): End with:\nWould you like me to run a web search to refine my understanding before starting research?\nA. Yes — search authoritative ISA sources to sharpen the query plan\nB. No — proceed directly with the current query plan\n\nIMPORTANT: Present this ONCE. After the user responds, the resume protocol handles the next step — do NOT re-present this output."
      },
      {
        "id": 1,
        "name": "websearch_calibration",
        "description": "Optional web search to refine intent and query plan",
        "pauseInstructions": "Present what the web search revealed and how it changed the query plan.\n\nFORMAT:\n- First line: CALIBRATED (if changes found) or CONFIRMED (if no changes)\n- 1-3 sentences summarizing what web sources revealed\n- 'Changes made:' section listing additions/modifications/removals\n- 'Full updated research plan:' listing ALL sub-queries with roles (mark NEW and MODIFIED)\n- End with: 'Shall I proceed?\\n1. Yes — start retrieval with the refined query plan\\n2. Modify — I'd like to adjust something before proceeding'\n\nIMPORTANT: Present this ONCE. After the user responds, the resume protocol handles the next step — do NOT re-present this output."
      },
      { "id": 2, "name": "retrieve", "description": "Hybrid search + graph traversal + context formatting" },
      { "id": 3, "name": "synthesize", "description": "Generate structured answer from XML context" },
      { "id": 4, "name": "verify", "description": "4-axis verification (EG, CA, RP, CD)" },
      { "id": 5, "name": "output", "description": "Format final output with progressive disclosure" }
    ],
    "repairUnits": [
      {
        "stages": [3, 4],
        "maxIterations": 2,
        "feedbackField": "repair_instructions"
      }
    ],
    "pauseAfterStages": [0, 1],
    "autoAdvance": true,
    "pauseOnErrors": ["auth", "config"],
    "stageOutputSchemas": {
      "0": {
        "required": ["query_plan"],
        "properties": {
          "query_plan": {
            "type": "object",
            "required": ["original_query", "sub_queries", "depth_mode"],
            "properties": {
              "original_query": { "type": "string" },
              "sub_queries": { "type": "array", "minItems": 1 },
              "depth_mode": { "type": "string", "enum": ["quick", "standard", "deep"] },
              "assumptions": { "type": "array" },
              "alternative_interpretations": { "type": "array" },
              "recommended_action": { "type": "string", "enum": ["proceed", "clarify"] }
            }
          }
        }
      },
      "1": {
        "required": ["websearch_calibration"],
        "properties": {
          "websearch_calibration": {
            "type": "object",
            "required": ["skipped", "query_plan_refined"],
            "properties": {
              "skipped": { "type": "boolean" },
              "skip_reason": { "type": "string" },
              "web_queries_executed": { "type": "number" },
              "web_sources": { "type": "array" },
              "intent_changes": {
                "type": "object",
                "properties": {
                  "sub_queries_added": { "type": "array" },
                  "sub_queries_modified": { "type": "array" },
                  "sub_queries_removed": { "type": "array" },
                  "scope_changed": { "type": "boolean" },
                  "standards_added": { "type": "array" }
                }
              },
              "query_plan_refined": { "type": "boolean" }
            }
          }
        }
      },
      "2": {
        "required": ["retrieval_summary"],
        "properties": {
          "retrieval_summary": {
            "type": "object",
            "required": ["total_paragraphs_found", "unique_after_dedup", "standards_covered"],
            "properties": {
              "total_paragraphs_found": { "type": "number" },
              "unique_after_dedup": { "type": "number" },
              "standards_covered": { "type": "array", "minItems": 1 }
            }
          }
        }
      },
      "3": {
        "required": ["synthesis", "citations_used"],
        "properties": {
          "synthesis": { "type": "string" },
          "citations_used": { "type": "array", "minItems": 1 }
        }
      },
      "4": {
        "required": ["verification_scores", "all_passed"],
        "properties": {
          "verification_scores": { "type": "object" },
          "all_passed": { "type": "boolean" }
        }
      },
      "5": {
        "required": ["answer_delivered", "output_file_path"],
        "properties": {
          "answer_delivered": { "type": "boolean" },
          "total_citations": { "type": "number" },
          "output_file_path": { "type": "string" }
        },
        "enforcement": "block",
        "blockMessage": "Stage 5 BLOCKED: You MUST (1) write the full research output to ./isa-research-output.md, (2) include the COMPLETE formatted research with citations in your response to the user, and (3) re-complete Stage 5 with answer_delivered: true and output_file_path set to the file path. Do NOT skip the output file or the inline research content."
      }
    },
    "webSearch": {
      "enabled": true,
      "provider": "brave",
      "maxQueries": 5,
      "preferredDomains": [
        "ifac.org",
        "iaasb.org",
        "pcaobus.org",
        "aicpa.org",
        "accountancyeurope.eu"
      ]
    }
  },
  "depthModes": {
    "quick": {
      "maxSubQueries": 3,
      "maxParagraphsPerQuery": 10,
      "maxRepairIterations": 0,
      "contextTokenBudget": 4000,
      "enableWebSearch": false
    },
    "standard": {
      "maxSubQueries": 8,
      "maxParagraphsPerQuery": 20,
      "maxRepairIterations": 2,
      "contextTokenBudget": 8000,
      "enableWebSearch": true
    },
    "deep": {
      "maxSubQueries": 15,
      "maxParagraphsPerQuery": 30,
      "maxRepairIterations": 3,
      "contextTokenBudget": 16000,
      "enableWebSearch": true
    }
  },
  "verification": {
    "entityGrounding": { "threshold": 0.80 },
    "relationPreservation": { "threshold": 0.70 },
    "citationAccuracy": { "threshold": 0.75 },
    "contradictions": { "maxUnresolved": 0 }
  },
  "logging": {
    "level": "verbose",
    "persistIntermediates": true,
    "costTracking": true
  },
  "followUp": {
    "enabled": true,
    "deltaRetrieval": true,
    "maxAccumulatedSections": 30
  },
  "output": {
    "progressiveDisclosure": true,
    "citationFormat": "ISA {number}.{paragraph}"
  },
  "debug": {
    "enabled": false,
    "maxParagraphs": 5,
    "maxToolCalls": 10,
    "skipVerification": false,
    "skipWebSearch": true,
    "useFixtures": false
  }
}
